

<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>حجز الوحدات السكنية</title>
  
  <!-- ربط مكتبة Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- ربط DataTables مع Bootstrap -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">
  
  <style>
    body {
      direction: rtl;
      text-align: center;
      background-color: #f9f9f9;
    }
    header img {
      height: 60px;
    }
    /* يمكن إضافة أنماط إضافية مخصصة إذا لزم الأمر */
  </style>
</head>
<body>
  <header class="d-flex justify-content-between align-items-center p-2 bg-white shadow-sm">
    <img src="https://media.licdn.com/dms/image/v2/C4D0BAQED93e7d7lWkQ/company-logo_200_200/company-logo_200_200/0/1630490580332?e=2147483647&v=beta&t=hCmFNUBkdnBTYQZvWm7qHm89w_zro06Rr-b2Eup0Ec8" alt="لوجو الشركة">
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQiNel1DsK7PJmkRJp6xLUH8WAbZ6d0L1PVnw&s" alt="لوجو المشروع">
  </header>
  
  <div class="container my-4">
    <!-- رسالة معلومات -->
    <div class="alert alert-info text-right">
      <strong>عزيزي المستفيد:</strong> حجز الوحدة لا يعني أنه حجز نهائي. يتوجب عليك دفع رسوم قدرها <strong>805 ريال</strong>
      على حسابك في تطبيق سكني بعد استلام رسالة الحجز.
    </div>

    <h1 class="text-center my-4">الوحدات السكنية المتاحة</h1>

    <!-- جدول الوحدات -->
    <table id="units-table" class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>رقم الوحدة</th>
          <th>رقم الدور</th>
          <th>القيمة السوقية</th>
          <th>القيمة قبل الدعم</th>
          <th>المساحة</th>
          <th>رابط المخطط</th>
          <th>إجراء</th>
        </tr>
      </thead>
      <tbody>
        <!-- سيتم تعبئة الجدول ديناميكيًا عبر JavaScript -->
      </tbody>
    </table>

    <!-- أزرار الفيديو -->
    <div class="text-center my-3">
      <button class="btn btn-primary video-btn" onclick="openVideoModal('ssstwitter.com_1733215444678.mp4')">فيديو 1</button>
      <button class="btn btn-primary video-btn" onclick="openVideoModal('vd2.mp4')">فيديو 2</button>
      <button class="btn btn-primary video-btn" onclick="openVideoModal('vd3.mp4')">فيديو 3</button>
      <button class="btn btn-primary video-btn" onclick="openVideoModal('vd4.mp4')">فيديو 4</button>
    </div>

    <!-- زر حساب القسط -->
    <div class="text-center my-3">
      <button class="btn installment-btn" onclick="openInstallmentModal()">حساب القسط الشهري</button>
    </div>
  </div>

  <!-- نافذة الفيديو المنبثقة -->
  <div id="video-modal" class="modal d-flex" style="display:none;">
    <div class="modal-content">
      <button class="btn btn-danger mb-2" onclick="closeVideoModal()">×</button>
      <video id="video-player" width="100%" controls>
        <source id="video-source" src="" type="video/mp4">
        متصفحك لا يدعم تشغيل الفيديو.
      </video>
    </div>
  </div>

  <!-- نافذة حساب القسط -->
  <div id="installment-modal" class="modal d-flex" style="display:none;">
    <div class="modal-content">
      <button class="btn btn-danger mb-2" onclick="closeInstallmentModal()">×</button>
      <h2>حساب القسط الشهري</h2>
      <form id="installment-form">
        <input id="salary" type="number" placeholder="الراتب الشهري" class="form-control my-2">
        <input id="loanAmount" type="number" placeholder="مبلغ الوحدة قبل الدعم" class="form-control my-2">
        <input id="durationMonths" type="number" placeholder="مدة التمويل (بالأشهر)" class="form-control my-2">
        <input id="interestRate" type="number" placeholder="نسبة البنك (٪)" class="form-control my-2">
        <input id="commitment1" type="number" placeholder="التزام 1" class="form-control my-2">
        <input id="commitmentMonths1" type="number" placeholder="مدة التزام 1 (بالأشهر)" class="form-control my-2">
        <input id="commitment2" type="number" placeholder="التزام 2" class="form-control my-2">
        <input id="commitmentMonths2" type="number" placeholder="مدة التزام 2 (بالأشهر)" class="form-control my-2">
        <input id="commitment3" type="number" placeholder="التزام 3" class="form-control my-2">
        <input id="commitmentMonths3" type="number" placeholder="مدة التزام 3 (بالأشهر)" class="form-control my-2">
        <input id="commitment4" type="number" placeholder="التزام 4" class="form-control my-2">
        <input id="commitmentMonths4" type="number" placeholder="مدة التزام 4 (بالأشهر)" class="form-control my-2">
        <button type="button" class="btn btn-primary" onclick="calculateInstallment()">حساب القسط</button>
      </form>
    </div>
  </div>

  <!-- نافذة النتيجة -->
  <div id="result-modal" class="result-modal d-flex" style="display:none;">
    <div class="result-content">
      <h3>نتيجة الحساب</h3>
      <p id="result-message">...</p>
      <button class="btn btn-success" onclick="closeResultModal()">إغلاق</button>
    </div>
  </div>

  <footer class="text-muted py-3">
    © 2024 - نظام حجز الوحدات السكنية
  </footer>
  
  <!-- ربط مكتبة jQuery، Popper.js، وBootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- ربط DataTables JS -->
  <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
  
  <script>
    // تهيئة DataTables للجدول
    $(document).ready(function() {
      $('#units-table').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Arabic.json'
        }
      });
    });

    // دوال تشغيل وإغلاق الفيديو
    function openVideoModal(videoFileName) {
      const videoPlayer = document.getElementById("video-player");
      const videoSource = document.getElementById("video-source");
      videoSource.src = videoFileName;
      videoPlayer.load();
      document.getElementById("video-modal").style.display = "flex";
    }

    function closeVideoModal() {
      const videoPlayer = document.getElementById("video-player");
      videoPlayer.pause();
      document.getElementById("video-modal").style.display = "none";
    }

    // دوال فتح وإغلاق نافذة الحساب
    function openInstallmentModal() {
      document.getElementById("installment-modal").style.display = "flex";
    }

    function closeInstallmentModal() {
      document.getElementById("installment-modal").style.display = "none";
    }

    // دوال فتح وإغلاق نافذة النتيجة
    function openResultModal(message) {
      const modal = document.getElementById("result-modal");
      const resultMessage = document.getElementById("result-message");
      resultMessage.innerHTML = message; // سيتم تعيين تنسيق النتيجة في الدالة calculateInstallment
      modal.style.display = "flex";
    }

    function closeResultModal() {
      document.getElementById("result-modal").style.display = "none";
    }

function calculateInstallment() {
  const salary = parseFloat(document.getElementById("salary").value) || 0;
  let unitAmount = parseFloat(document.getElementById("loanAmount").value) || 0;
  const durationMonths = parseFloat(document.getElementById("durationMonths").value) || 0;
  const interestRate = parseFloat(document.getElementById("interestRate").value) || 0;

  const commitments = [
    { amount: parseFloat(document.getElementById("commitment1").value) || 0, months: parseInt(document.getElementById("commitmentMonths1").value) || 0 },
    { amount: parseFloat(document.getElementById("commitment2").value) || 0, months: parseInt(document.getElementById("commitmentMonths2").value) || 0 },
    { amount: parseFloat(document.getElementById("commitment3").value) || 0, months: parseInt(document.getElementById("commitmentMonths3").value) || 0 },
    { amount: parseFloat(document.getElementById("commitment4").value) || 0, months: parseInt(document.getElementById("commitmentMonths4").value) || 0 },
  ];

  // تطبيق الخصم بناءً على الراتب
  const discount = salary < 10000 ? 150000 : 100000;
  unitAmount -= discount;

  // حساب الفائدة الإجمالية
  const totalInterest = unitAmount * (interestRate / 100) * (durationMonths / 12);

  // حساب الفائدة الشهرية
  const monthlyInterest = totalInterest / durationMonths;

  // المرحلة الأولى (قسط + الالتزامات الحالية)
  const maxCommitmentMonths = Math.max(...commitments.map(c => c.months));
  const totalCommitments = commitments.reduce((sum, c) => sum + c.amount, 0);

  const firstPhaseInstallment = monthlyInterest + totalCommitments;
  const firstPhaseCommitmentPercentage = ((firstPhaseInstallment / salary) * 100).toFixed(2);

  let requiredDownPayment = 0; // الدفعة المقدمة إذا لزم الأمر
  let financingMessage = "";

  if (totalCommitments === 0) {
    // في حال عدم وجود التزامات، تكون النتيجة على مرحلة واحدة فقط
    const singlePhaseInstallment = (unitAmount + totalInterest) / durationMonths;
    const singlePhaseCommitmentPercentage = ((singlePhaseInstallment / salary) * 100).toFixed(2);

    if (singlePhaseCommitmentPercentage > 65) {
      requiredDownPayment = ((singlePhaseInstallment - salary * 0.65) * durationMonths);
      financingMessage = `لا يمكن تمويلك إلا في حال وفرت دفعة قدرها ${requiredDownPayment.toFixed(2)} ريال وذلك لأن التزاماتك تعدت نسبة 65%.`;
    } else {
      financingMessage = "التمويل ممكن بناءً على المعلومات المدخلة.";
    }

    openResultModal({
      firstPhaseInstallment: singlePhaseInstallment,
      firstPhaseDuration: durationMonths,
      firstPhaseCommitmentPercentage: singlePhaseCommitmentPercentage,
      secondPhaseInstallment: 0,
      secondPhaseDuration: 0,
      secondPhaseCommitmentPercentage: 0,
      unitAmount: unitAmount,
      discount: discount,
      totalInterest: totalInterest,
      totalUnitWithInterest: unitAmount + totalInterest,
      financingMessage: financingMessage,
      requiredDownPayment: requiredDownPayment,
    });

    return;
  }

  // إذا كانت هناك التزامات، تخصيص المرحلة الأولى بنسبة استقطاع 65% كحد أقصى
  const maxAllowedInstallment = salary * 0.65;
  const firstPhaseDuration = Math.min(maxCommitmentMonths, durationMonths);
  const remainingLoan = unitAmount + totalInterest - (maxAllowedInstallment * firstPhaseDuration);

  if (remainingLoan > 0) {
    // حساب المرحلة الثانية
    const secondPhaseDuration = durationMonths - firstPhaseDuration;
    const secondPhaseInstallment = remainingLoan / secondPhaseDuration;
    const secondPhaseCommitmentPercentage = ((secondPhaseInstallment / salary) * 100).toFixed(2);

    financingMessage = "التمويل ممكن بناءً على المعلومات المدخلة.";

    openResultModal({
      firstPhaseInstallment: maxAllowedInstallment,
      firstPhaseDuration: firstPhaseDuration,
      firstPhaseCommitmentPercentage: 65,
      secondPhaseInstallment: secondPhaseInstallment,
      secondPhaseDuration: secondPhaseDuration,
      secondPhaseCommitmentPercentage: secondPhaseCommitmentPercentage,
      unitAmount: unitAmount,
      discount: discount,
      totalInterest: totalInterest,
      totalUnitWithInterest: unitAmount + totalInterest,
      financingMessage: financingMessage,
      requiredDownPayment: requiredDownPayment,
    });
  } else {
    // إذا لم تكن هناك حاجة لمرحلة ثانية
    financingMessage = "التمويل ممكن بناءً على المعلومات المدخلة.";

    openResultModal({
      firstPhaseInstallment: maxAllowedInstallment,
      firstPhaseDuration: firstPhaseDuration,
      firstPhaseCommitmentPercentage: 65,
      secondPhaseInstallment: 0,
      secondPhaseDuration: 0,
      secondPhaseCommitmentPercentage: 0,
      unitAmount: unitAmount,
      discount: discount,
      totalInterest: totalInterest,
      totalUnitWithInterest: unitAmount + totalInterest,
      financingMessage: financingMessage,
      requiredDownPayment: requiredDownPayment,
    });
  }
}






function openInstallmentModal() {
      document.getElementById("installment-modal").style.display = "flex";
    }

    function closeInstallmentModal() {
      document.getElementById("installment-modal").style.display = "none";
    }

    const apiUrl = "https://script.google.com/macros/s/AKfycbxKxVCedeb8P_HHvxdrlCroIyxzcH3n9Mmzcb15mi2l7mrQ_uKWEfjfxNHnHI4XYCKK/exec";
    let selectedUnitNumber = null; // لتخزين رقم الوحدة المحددة

    async function fetchData() {
      try {
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (Array.isArray(data)) {
          const tableBody = document.querySelector("#units-table tbody");
          tableBody.innerHTML = ""; 

          data.forEach(unit => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${unit.unitNumber}</td>
              <td>${unit.floorNumber}</td>
              <td>${unit.marketPrice}</td>
              <td>${unit.discountedPrice}</td>
              <td>${unit.size}</td>
              <td><a href="${unit.planLink}" target="_blank">عرض المخطط</a></td>
              <td><button class="btn" onclick="openModal('${unit.unitNumber}')">حجز</button></td>
            `;
            tableBody.appendChild(row);
          });
        } else if (data.error) {
          alert(data.error);
        }
      } catch (error) {
        console.error("حدث خطأ أثناء جلب البيانات:", error);
        alert("حدث خطأ أثناء جلب البيانات. يرجى المحاولة لاحقًا.");
      }
    }
        // دالة لحجز الوحدة
    async function reserveUnit() {
      const userId = document.getElementById("userId").value;
      const phone = document.getElementById("phone").value;

      if (!userId || !phone) {
        alert("يجب إدخال رقم الهوية ورقم الجوال لإتمام الحجز.");
        return;
      }

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams({
            unitNumber: selectedUnitNumber,
            userId: userId,
            phone: phone
          })
        });

        const result = await response.json();

        if (result.error) {
          alert(result.error);
        } else {
          alert(result.success);
          closeModal();
          fetchData(); // تحديث الجدول بعد الحجز
        }
      } catch (error) {
        console.error("حدث خطأ أثناء الحجز:", error);
        alert("حدث خطأ أثناء الحجز. يرجى المحاولة لاحقًا.");
      }
    }

    // إضافة الحدث على زر "احجز الآن"
    document.getElementById("confirmBooking").addEventListener("click", reserveUnit);

    function openModal(unitNumber) {
      selectedUnitNumber = unitNumber;
      document.getElementById("modal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    document.getElementById("confirmBooking").addEventListener("click", reserveUnit);

    fetchData();


  </script>
</body>
</html>

